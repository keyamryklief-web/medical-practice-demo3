<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr Khan Medical Practice - AI Receptionist</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh; color: white;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0 20px 0; }
        .logo { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; }
        .logo .dr { color: #38bdf8; }
        .logo .name { color: #ffffff; }
        .logo .practice { color: #94a3b8; font-size: 0.5em; display: block; font-weight: normal; margin-top: 5px; }
        .tagline { color: #64748b; font-size: 1em; font-style: italic; margin-top: 5px; }
        .badge-container { margin-top: 15px; }
        .badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; margin: 3px; }
        .badge-ai { background: linear-gradient(90deg, #38bdf8, #818cf8); color: white; }
        .badge-safe { background: linear-gradient(90deg, #10b981, #059669); color: white; }
        .badge-247 { background: linear-gradient(90deg, #f59e0b, #d97706); color: white; }
        .badge-lang { background: linear-gradient(90deg, #ec4899, #8b5cf6); color: white; }
        .emergency-banner {
            background: linear-gradient(90deg, #dc2626, #991b1b);
            padding: 12px 20px; border-radius: 10px; margin: 15px 0;
            text-align: center; font-size: 0.85em; border: 1px solid #f87171;
        }
        .emergency-banner strong { color: #fef2f2; }
        .emergency-banner a { color: #fecaca; font-weight: bold; text-decoration: none; }
        .agent-card {
            background: rgba(255,255,255,0.05); border-radius: 20px; padding: 30px;
            margin: 20px 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .agent-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .agent-avatar {
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(135deg, #38bdf8, #818cf8);
            display: flex; align-items: center; justify-content: center;
            font-size: 2em; flex-shrink: 0;
        }
        .agent-info h2 { font-size: 1.3em; margin-bottom: 3px; }
        .agent-info p { color: #94a3b8; font-size: 0.9em; }
        .mic-container { text-align: center; margin: 30px 0; }
        #micButton {
            width: 110px; height: 110px; border-radius: 50%; border: none;
            background: linear-gradient(145deg, #38bdf8, #0284c7); color: white;
            font-size: 2.8em; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(56, 189, 248, 0.3);
        }
        #micButton:hover { transform: scale(1.05); }
        #micButton.listening { background: linear-gradient(145deg, #10b981, #059669); animation: pulse 1s infinite; }
        #micButton.processing { background: linear-gradient(145deg, #818cf8, #6366f1); }
        #micButton.speaking { background: linear-gradient(145deg, #f59e0b, #d97706); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        #status { margin-top: 15px; font-size: 1em; color: #38bdf8; }
        .lang-selector { text-align: center; margin: 10px 0; }
        .lang-btn {
            padding: 5px 14px; margin: 3px; border-radius: 15px;
            border: 1px solid #334155; background: rgba(0,0,0,0.3);
            color: #94a3b8; cursor: pointer; font-size: 0.8em; transition: all 0.2s;
        }
        .lang-btn:hover, .lang-btn.active { background: rgba(56,189,248,0.2); border-color: #38bdf8; color: #38bdf8; }
        .conversation {
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px;
            max-height: 320px; overflow-y: auto; margin-top: 20px;
        }
        .message { padding: 12px 18px; margin: 8px 0; border-radius: 15px; max-width: 85%; animation: fadeIn 0.3s ease; font-size: 0.95em; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .user-message { background: linear-gradient(90deg, #818cf8, #6366f1); margin-left: auto; text-align: right; }
        .agent-message { background: rgba(56,189,248,0.12); border: 1px solid rgba(56,189,248,0.25); }
        .emergency-message { background: rgba(220,38,38,0.2); border: 1px solid rgba(220,38,38,0.4); }
        .text-input-area {
            padding: 12px 15px; border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; gap: 8px; margin-top: 15px;
        }
        .text-input-area input {
            flex: 1; padding: 10px 14px; border: 1px solid #334155;
            border-radius: 10px; background: rgba(0,0,0,0.4);
            color: white; font-size: 0.85em; outline: none;
        }
        .text-input-area input::placeholder { color: #475569; }
        .send-btn {
            width: 42px; height: 42px; border-radius: 50%; border: none;
            background: linear-gradient(145deg, #10b981, #059669);
            color: white; font-size: 1.1em; cursor: pointer;
        }
        .config-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-top: 20px; }
        .config-panel label { display: block; color: #64748b; font-size: 0.8em; margin-bottom: 5px; }
        .config-panel input {
            width: 100%; padding: 10px; border: 1px solid #334155; border-radius: 8px;
            background: rgba(0,0,0,0.5); color: white; font-size: 0.85em; margin-bottom: 10px;
        }
        .config-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
        .clear-btn { padding: 8px 16px; background: #dc2626; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.8em; }
        .clear-btn:hover { background: #b91c1c; }
        .toggle-label { display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 0.8em; }
        .toggle-switch { position: relative; width: 44px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155; transition: .3s; border-radius: 22px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 16px; width: 16px;
            left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .toggle-slider { background: linear-gradient(90deg, #38bdf8, #818cf8); }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        .services-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 25px; }
        .service-card {
            background: rgba(255,255,255,0.03); padding: 18px; border-radius: 15px;
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .service-card .icon { font-size: 1.8em; margin-bottom: 8px; }
        .service-card h3 { font-size: 0.85em; margin-bottom: 4px; color: #38bdf8; }
        .service-card p { color: #475569; font-size: 0.75em; }
        .contact-info { text-align: center; margin-top: 25px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .contact-info p { color: #64748b; font-size: 0.85em; margin: 4px 0; }
        .contact-info a { color: #38bdf8; text-decoration: none; }
        .powered-by { text-align: center; margin-top: 25px; color: #334155; font-size: 0.75em; }
        @media (max-width: 600px) {
            .services-preview { grid-template-columns: 1fr; }
            .agent-header { flex-direction: column; text-align: center; }
            #micButton { width: 100px; height: 100px; font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="dr">Dr </span><span class="name">Khan</span>
                <span class="practice">Medical Practice</span>
            </div>
            <p class="tagline">Your health, our priority</p>
            <div class="badge-container">
                <span class="badge badge-ai">AI Receptionist</span>
                <span class="badge badge-safe">Emergency Detection</span>
                <span class="badge badge-247">24/7 Available</span>
                <span class="badge badge-lang">EN / AF / XH</span>
            </div>
        </header>

        <div class="emergency-banner">
            <strong>Medical Emergency?</strong> Call <a href="tel:10177">10177</a> (Ambulance) or go to your nearest ER.
            Mental health crisis: <a href="tel:0800567567">0800 567 567</a> (SADAG)
        </div>

        <div class="agent-card">
            <div class="agent-header">
                <div class="agent-avatar">&#9877;</div>
                <div class="agent-info">
                    <h2>Leah - AI Receptionist</h2>
                    <p>Book appointments, ask about services, or get practice info</p>
                </div>
            </div>

            <div class="lang-selector">
                <button class="lang-btn active" onclick="setLanguage('en-ZA')">English</button>
                <button class="lang-btn" onclick="setLanguage('af-ZA')">Afrikaans</button>
                <button class="lang-btn" onclick="setLanguage('xh-ZA')">isiXhosa</button>
            </div>

            <div class="mic-container">
                <button id="micButton" onclick="toggleListening()">&#127908;</button>
                <p id="status">Click to start talking</p>
            </div>

            <div class="conversation" id="conversation">
                <div class="message agent-message">
                    Good morning! Welcome to Dr Khan's practice. I'm Leah, the AI receptionist. I can help you book an appointment, answer questions about the practice, or provide general information. Click the microphone or type below to chat!
                </div>
            </div>

            <div class="text-input-area">
                <input type="text" id="textInput" placeholder="Type here for names, emails, numbers..."
                    onkeypress="if(event.key==='Enter')sendTextMessage()">
                <button class="send-btn" onclick="sendTextMessage()">&#10148;</button>
            </div>

            <div class="config-panel">
                <label>n8n Webhook URL:</label>
                <input type="text" id="webhookUrl" value="https://automation.ryklief.org/webhook/medical-voice-agent">
                <div class="config-row">
                    <label class="toggle-label">
                        <span>Auto-listen after response:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoContinue" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <button class="clear-btn" onclick="clearConversation()">New Chat</button>
                </div>
            </div>
        </div>

        <div class="services-preview">
            <div class="service-card">
                <div class="icon">&#128197;</div>
                <h3>Book Appointment</h3>
                <p>Schedule your visit with a doctor</p>
            </div>
            <div class="service-card">
                <div class="icon">&#128138;</div>
                <h3>Repeat Scripts</h3>
                <p>Chronic medication refills</p>
            </div>
            <div class="service-card">
                <div class="icon">&#129656;</div>
                <h3>Vaccinations</h3>
                <p>Flu shots and immunisations</p>
            </div>
        </div>

        <div class="contact-info">
            <p><strong>Dr Khan Medical Practice</strong></p>
            <p>123 Main Road, Cape Town</p>
            <p><a href="tel:0210000000">021 000 0000</a> | <a href="mailto:info@drkhan.co.za">info@drkhan.co.za</a></p>
            <p>Mon-Fri 08:00-17:00 | Sat 08:00-12:00</p>
        </div>

        <p class="powered-by">AI Voice Receptionist - Powered by Groq AI + Deepgram</p>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        let conversationHistory = [];
        let currentAudio = null;
        let selectedLang = 'en-ZA';

        function setLanguage(lang) {
            selectedLang = lang;
            if (recognition) recognition.lang = lang;
            document.querySelectorAll('.lang-btn').forEach(function(btn) { btn.classList.remove('active'); });
            event.target.classList.add('active');
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = selectedLang;

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('micButton').className = 'listening';
                document.getElementById('status').textContent = 'Listening... Speak now';
            };
            recognition.onend = function() {
                isListening = false;
                if (!isSpeaking) document.getElementById('micButton').className = '';
            };
            recognition.onresult = async function(event) {
                var transcript = event.results[0][0].transcript;
                if (!event.results[0].isFinal) {
                    document.getElementById('status').textContent = 'Hearing: ' + transcript + '...';
                    return;
                }
                addMessage(transcript, 'user');
                document.getElementById('micButton').className = 'processing';
                document.getElementById('status').textContent = 'Thinking...';
                await sendToAgent(transcript);
            };
            recognition.onerror = function(event) {
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    document.getElementById('status').textContent = 'Error: ' + event.error;
                }
                document.getElementById('micButton').className = '';
            };
        } else {
            document.getElementById('status').textContent = 'Speech recognition not supported. Please use Chrome.';
            document.getElementById('micButton').disabled = true;
        }

        function clearConversation() {
            conversationHistory = [];
            stopAllAudio();
            document.getElementById('conversation').innerHTML = '<div class="message agent-message">Chat cleared! How can I help you?</div>';
            document.getElementById('status').textContent = 'Click to start talking';
        }

        function stopAllAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio.src = ''; currentAudio = null; }
            if ('speechSynthesis' in window) speechSynthesis.cancel();
            isSpeaking = false;
            document.getElementById('micButton').className = '';
        }

        function toggleListening() {
            if (isSpeaking) { stopAllAudio(); document.getElementById('status').textContent = 'Click to continue'; return; }
            if (isListening) { recognition.stop(); }
            else { recognition.lang = selectedLang; try { recognition.start(); } catch(e) {} }
        }

        function addMessage(text, type) {
            var conversation = document.getElementById('conversation');
            var div = document.createElement('div');
            var msgClass = type + '-message';
            if (type === 'agent') {
                var lower = text.toLowerCase();
                if (lower.includes('10177') || lower.includes('emergency') || lower.includes('ambulance')) {
                    msgClass = 'emergency-message';
                }
            }
            div.className = 'message ' + msgClass;
            div.textContent = text;
            conversation.appendChild(div);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function sendTextMessage() {
            var input = document.getElementById('textInput');
            var msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            addMessage(msg, 'user');
            document.getElementById('micButton').className = 'processing';
            document.getElementById('status').textContent = 'Thinking...';
            sendToAgent(msg);
        }

        async function sendToAgent(message) {
            var webhookUrl = document.getElementById('webhookUrl').value;
            if (!webhookUrl) { addMessage('Please enter your webhook URL.', 'agent'); return; }
            try {
                var response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, businessType: 'medical', history: conversationHistory })
                });
                var data = await response.json();
                if (data.response) {
                    addMessage(data.response, 'agent');
                    if (data.history) { conversationHistory = data.history; }
                    else {
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: data.response });
                    }
                    if (data.audioAvailable && data.audio) { playPremiumAudio(data.audio, data.audioFormat || 'mp3', data.response); }
                    else { speakWithBrowser(data.response); }
                } else {
                    addMessage('Sorry, please try again.', 'agent');
                    document.getElementById('micButton').className = '';
                    document.getElementById('status').textContent = 'Click to try again';
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Connection error. Please check the webhook URL.', 'agent');
                document.getElementById('micButton').className = '';
                document.getElementById('status').textContent = 'Connection error';
            }
        }

        function playPremiumAudio(base64Audio, format, textFallback) {
            try {
                isSpeaking = true;
                document.getElementById('micButton').className = 'speaking';
                document.getElementById('status').textContent = 'Speaking (Premium Voice)...';
                var binaryString = atob(base64Audio);
                var bytes = new Uint8Array(binaryString.length);
                for (var i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
                var mimeType = format === 'wav' ? 'audio/wav' : 'audio/mpeg';
                var audioBlob = new Blob([bytes.buffer], { type: mimeType });
                var audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                currentAudio.onended = function() {
                    isSpeaking = false;
                    document.getElementById('micButton').className = '';
                    document.getElementById('status').textContent = 'Click to continue';
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    autoListen();
                };
                currentAudio.onerror = function() { URL.revokeObjectURL(audioUrl); currentAudio = null; speakWithBrowser(textFallback); };
                currentAudio.play().catch(function() { URL.revokeObjectURL(audioUrl); currentAudio = null; speakWithBrowser(textFallback); });
            } catch(e) { speakWithBrowser(textFallback); }
        }

        function speakWithBrowser(text) {
            if ('speechSynthesis' in window) {
                isSpeaking = true;
                document.getElementById('micButton').className = 'speaking';
                document.getElementById('status').textContent = 'Speaking (Browser Voice)...';
                speechSynthesis.cancel();
                var utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = selectedLang;
                utterance.rate = 0.95;
                var voices = speechSynthesis.getVoices();
                var langPrefix = selectedLang.split('-')[0];
                var pv = voices.find(function(v) { return v.lang.includes(langPrefix); });
                if (!pv) pv = voices.find(function(v) { return v.lang.includes('en'); });
                if (pv) utterance.voice = pv;
                utterance.onend = function() { isSpeaking = false; document.getElementById('micButton').className = ''; document.getElementById('status').textContent = 'Click to continue'; autoListen(); };
                utterance.onerror = function() { isSpeaking = false; document.getElementById('micButton').className = ''; document.getElementById('status').textContent = 'Click to continue'; };
                speechSynthesis.speak(utterance);
            }
        }

        function autoListen() {
            if (document.getElementById('autoContinue').checked && recognition) {
                setTimeout(function() { if (!isSpeaking && !isListening) { try { recognition.start(); } catch(e) {} } }, 600);
            }
        }

        if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = function() { speechSynthesis.getVoices(); }; }
    </script>
</body>
</html>
